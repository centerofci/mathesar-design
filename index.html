<!doctype html>
<html class="no-js" lang="en">

<head>
  <meta charset="utf-8">
  <title></title>
  <base href="/">
  <meta name="description" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <meta property="og:title" content="">
  <meta property="og:type" content="">
  <meta property="og:url" content="">
  <meta property="og:image" content="">

  <link rel="manifest" href="site.webmanifest">
  <link rel="apple-touch-icon" href="icon.png">
  <!-- Place favicon.ico in the root directory -->

  <link rel="stylesheet" href="css/normalize.css">
  <link rel="stylesheet" href="css/main.css">
  <link href="https://unpkg.com/tailwindcss@^2/dist/tailwind.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/remixicon@2.5.0/fonts/remixicon.css" rel="stylesheet">


  <meta name="theme-color" content="#fafafa">

</head>

<body class="mediumBackgroundColor">

  <!-- Add your site or application content here -->

  <div style="height: 100vh;">
    <div class="py-2 px-3 mediumBorderColor border-b backgroundColor flex items-center space-x-3">
      <div class="flex space-x-2 items-center">
        <div class="primaryColor inverseTextColor text-sm px-1 rounded">M</div>
        <div class="textColor">album_collection</div>
      </div>
      <input type="text" class="inputBackgroundColor w-full p-2 text-sm textColor" placeholder="Search or jump toâ€¦">
      <button class="textColor py-1 px-2 border mediumBorderColor swap-theme"><i class="ri-sun-fill"></i></button>
    </div>
    <div class="grid grid-cols-6 justify-items-stretch h-full">
      <div class="col-span-1">
        <div class="backgroundColor h-full mediumBorderColor border-r sidebar-wrapper">
          <div class="flex items-center">
            <input type="text" class="inputBackgroundColor w-full p-2 text-sm textColor" placeholder="Type to search">
            <button class="px-2"><i class="ri-menu-line textColor align-bottom"></i></button>
          </div>
          <div class="sidebar-navigation"></div>


        </div>

      </div>
      <div class="col-span-5">
        <!--
        <div class="mediumBackgroundColor flex">
          <div class="textColor text-sm py-2 px-3"><i class="ri-table-fill align-bottom mr-1"></i> release <i
              class="ri-close-line align-bottom ml-3"></i> </div>
          <div class="textColor accentBackgroundColor text-sm py-2 px-3"><i class="ri-grid-fill align-bottom mr-1"></i>
            Total
            Tracks by Artist <i class="ri-close-line align-bottom ml-3"></i> </div>
          <div class="textColor text-sm py-2 px-3"><i class="ri-table-fill align-bottom mr-1"></i> artist <i
              class="ri-close-line align-bottom ml-3"></i> </div>

          <button class="primaryColor inverseTextColor px-3 text-sm"><i class="ri-add-line align-bottom"></i></button>
        </div>
     
        <div class="accentBackgroundColor border-b mediumBorderColor py-2 px-3 flex space-x-6 items-center">
          <h3 class="textColor text-lg">Total Releases by Artist <i class="ri-arrow-down-s-line align-bottom"></i></h3>
          <button class="textColor border lightBorderColor px-2 py-1"><i class="ri-add-line align-bottom"></i>
            Record</button>
          <div class="space-x-4 flex items-center">
            <button class="space-x-1 mediumBackgroundColor primaryBorderColor border py-1 px-2"><i
                class="ri-filter-line align-bottom textColor"></i><span class="font-semibold textColor">Filter</span>
              <div class="primaryColor inverseTextColor align-text-bottom inline-block rounded px-1 text-xs">3</div>
            </button>
            <div class="textColor">Sort</div>
            <div class="textColor">Group</div>
          </div>
          <button class="textColor border lightBorderColor px-2 py-1"><i class="ri-save-fill align-bottom"></i>
            Save</button>
          <div class="mutedTextColor">Saving Changes</div>
        </div>
        -->
        <div class="mediumBackgroundColor h-full flex items-start table-wrapper">
          <!--
          <button class="primaryColor inverseTextColor py-2 px-3" id="add-column"><i
              class="ri-add-line align-bottom"></i></button>
              -->

        </div>
      </div>
    </div>

  </div>


  <script type="text/javascript">

    localStorage.clear();

    var darkTheme = {
      backgroundColor: 'bg-gray-900',
      mediumBackgroundColor: 'bg-gray-800',
      accentBackgroundColor: 'bg-gray-700',
      lightBackgroundColor: 'bg-gray-200',
      darkBorderColor: 'border-gray-500',
      mediumBorderColor: 'border-gray-600',
      lightBorderColor: 'border-gray-500',
      textColor: 'text-gray-100',
      inverseTextColor: 'text-dark',
      mutedTextColor: 'text-gray-400',
      mediumTextColor: 'text-gray-200',
      tableBorderColor: 'border-gray-600',
      tableBackgroundColor: 'bg-gray-800',
      tableHeaderBackgroundColor: 'bg-gray-800',
      primaryColor: 'bg-indigo-300',
      primaryBorderColor: 'border-indigo-300',
      inputBackgroundColor: 'bg-gray-700',
      darkPrimaryColor: 'bg-indigo-800'
    };

    var lightTheme = {
      backgroundColor: 'bg-white',
      mediumBackgroundColor: 'bg-gray-200',
      accentBackgroundColor: 'bg-white',
      lightBackgroundColor: 'bg-gray-100',
      darkBorderColor: 'border-gray-600',
      mediumBorderColor: 'border-gray-400',
      lightBorderColor: 'border-gray-100',
      textColor: 'text-gray-600',
      inverseTextColor: 'text-white',
      mutedTextColor: 'text-gray-800',
      mediumTextColor: 'text-gray-900',
      tableBorderColor: 'border-gray-300',
      tableBackgroundColor: 'bg-white',
      tableHeaderBackgroundColor: 'bg-white',
      primaryColor: 'bg-indigo-400',
      primaryBorderColor: 'border-indigo-300',
      inputBackgroundColor: 'bg-gray-100',
      darkPrimaryColor: 'bg-indigo-800'
    }


    const urlParams = new URLSearchParams(window.location.search);
    var activeTheme = urlParams.get('theme');

    var defaultTheme = darkTheme;

    if (activeTheme == 'darkTheme') {
      var theme = darkTheme;
    } else if (activeTheme == 'lightTheme') {
      var theme = lightTheme;
    } else {
      var theme = defaultTheme;
    }

    for (const property in theme) { applyTheme(property, theme[property]); }

    function applyTheme(property, color) {
      document.querySelectorAll(`.${property}`).forEach(el => {
        el.classList.add(`${color}`);
      });
    }

    var schemaTables =
    {
      tables: [{
        name: 'artist',
        id: 0,
        columns: [
          { name: 'id', type: 'number', readOnly: true },
          { name: 'artistName', type: 'text' },
          { name: 'releaseId', type: 'fk', lookupField: 'releaseName', lookupTable: 'release' },
          //{ name: 'trackId', type: 'text' }
        ],
        records: [
          [449, 'Aqua', 'Aquarius'],
          [450, 'Patti Smith', 'Horses'],
          [451, 'Elvis Costello', 'Spike'],
          [451, 'Kylie Minogue', 'Golden'],
          [451, 'Artic Monkeys', 'AM'],
          [453, 'Scorpions', 'Animal Magnetism']
        ],
        color: 'purple'
      }, {
        name: 'release',
        id: 1,
        columns: [
          { name: 'id', type: 'number', readOnly: true },
          { name: 'releaseName', type: 'text' },
          { name: 'releaseGenre', type: 'text' }
        ],
        records: [
          [20, 'Aquarius', 'Pop'],
          [21, 'Aquarium', 'Pop'],
          [22, 'Spike', 'Rock'],
          [23, 'Golden', 'Pop'],
          [24, 'AM', 'Pop'],
          [25, 'Animal Magnetism', 'Rock']
        ],
        color: 'green'
      }, {
        name: 'track',
        id: 2,
        columns: [
          { name: 'id', type: 'number', readOnly: true },
          { name: 'trackName', type: 'text' },
          { name: 'trackLength', type: 'duration' }
        ],
        records: [
          [460, 'Turn Back Time', 180000],
          [461, 'Roses are Red', 180000],
          [462, 'Barbie Girl', 180000],
          [462, 'Around the World', 180000],
        ],
        color: 'pink'
      }, {
        name: 'track_artist',
        id: 3,
        columns: [
          { name: 'id', type: 'number', readOnly: true },
          { name: 'trackId', type: 'fk', lookupField: 'trackName', lookupTable: 'track' },
          { name: 'artistId', type: 'fk', lookupField: 'artistName', lookupTable: 'artist' },
        ],
        records: [
          [500, 'Around the World', ''],
          [501, 'Barbie Girl', ''],
          [502, 'Turn Back Time', ''],
          [503, 'Roses are Red', '']
        ],
        color: 'pink'
      }, {
        name: 'release_track',
        id: 8,
        columns: [
          { name: 'id', type: 'number', readOnly: true },
          { name: 'releaseId', type: 'fk', lookupField: 'releaseName', lookupTable: 'release' },
          { name: 'trackId', type: 'fk', lookupField: 'trackName', lookupTable: 'track' }
        ],
        records: [
          ['60', 'Aquarius', 'Roses are Red'],
          ['61', 'Aquarius', 'Around the World'],
          ['62', 'Aquarius', 'Barbie Girl'],
          ['63', 'Aquarius', 'Good Morning Sunshine']
        ],
        color: 'pink'
      }],
      views: [{
        name: 'Releases by Artist',
        id: 4,
        columns: [
          { name: 'artistName', type: 'text', referencedTable: 'artist' },
          { name: 'releaseName', type: 'text', referencedTable: 'release' }
        ],
        records: [
          ['Aqua', 'Aquarius'],
          ['Elvis Costello', 'Spike'],
          ['Kylie Minogue', 'Golden'],
          ['Artic Monkeys', 'AM'],
          ['Scorpions', 'Animal Magnetism']
        ],
        color: 'purple'
      }, {
        name: 'Release with Track',
        id: 10,
        columns: [
          { name: 'releaseName', type: 'text', referencedTable: 'release' },
          { name: 'trackName', type: 'summary', referencedTable: 'release_track', summaryOf: 'trackId' }
        ],
        records: [
          ['Aquarius', 'Roses are Red,Around the World,Good Morning Sunshine'],
          ['Aquarium', '']
        ],
        color: 'purple'
      }
      ]
    };

    //localStorage.clear();

    if (localStorage.getItem('tables') === null) {
      localStorage.setItem('tables', JSON.stringify(schemaTables));
    }


    let savedTables = JSON.parse(localStorage.getItem('tables'));
    console.log(savedTables);

    var activeTable = urlParams.get('activeTable');
    createSidebarNavigation(savedTables);
    document.querySelector('.table-wrapper').parentNode.prepend(createTableToolbar(selectTableById(activeTable)));
    document.querySelector('.table-wrapper').prepend(createTable(selectTableById(activeTable)));

    // CREATE SIDEBAR
    function createSidebarNavigation(schema) {
      let viewsNavigation = document.createElement('div')
      viewsNavigation.classList.add('views-navigation');
      document.querySelector('.sidebar-navigation').append(viewsNavigation);

      let tablesNavigation = document.createElement('div')
      tablesNavigation.classList.add('tables-navigation');
      document.querySelector('.sidebar-navigation').append(tablesNavigation);

      let objectHeader = function (key) {
        let listHeader = document.createElement('div');
        listHeader.classList.add('p-2', 'border-t', 'border-b', theme.mediumBorderColor)
        listHeader.innerHTML = `<div class="flex items-center space-x-2"><div class="uppercase text-xs font-bold ${theme.textColor}">${key}</div> <div class="${theme.lightBackgroundColor} ${theme.inverseTextColor} rounded px-1 text-xs">${schema[key].length}</div><div>`;
        return listHeader;
      };

      let objectList = function (key) {
        let obj = schema[key];
        let listItem = document.createElement('div');
        listItem.innerHTML = obj.map(item => `<div class="${theme.textColor}"><a class="p-2 block" href="${window.location.pathname}?activeTable=${item.id}"><i class="ri-table-fill align-bottom mr-2"></i>${item.name}</a></div>`).join('');
        return listItem;
      };

      Object.keys(schema).forEach(function (key) {
        document.querySelector(`.${key}-navigation`).append(objectHeader(key));
        document.querySelector(`.${key}-navigation`).append(objectList(key));
      });
    }

    // SELECT TABLE BY ID
    function selectTableById(id) {
      return Object.values(savedTables).flat().find(table => table.id == id);
    }
    // SELECT TABLE BY NAME
    function selectTableByName(name) {
      return Object.values(savedTables).flat().find(table => table.name == name);
    }

    // STATUS FOR TABS
    setTableStatus(selectTableById(activeTable), 'active');
    //setTableStatus(selectTableById(4), 'open');
    //setTableStatus(selectTableById(2), 'open');
    //
    function setTableStatus(table, status) {
      if (table.id == activeTable) {
        table.status = 'active';
      } else {
        table.status = status;
      }
    }

    // TABS

    document.querySelector('.table-wrapper').parentNode.prepend(createTabs(savedTables));
    function createTabs(tables) {
      let openTables = Object.values(tables).flat().filter(table => table.status);

      let createTab = table => `<div class="py-2 px-3 ${theme.textColor} ${table.status == 'active' ? theme.accentBackgroundColor : theme.backgroundColor}">${table.name}</div>`;

      let tab = openTables.map(table => createTab(table)).join('');

      let tabs = document.createElement('div');
      tabs.innerHTML = `<div class="flex items-center">${tab}</div>`

      return tabs;
    }

    function createButton(value, icon) {
      let btn = document.createElement('button');
      btn.classList.add('px-2', 'py-1', theme.textColor, 'border', theme.lightBorderColor)
      btn.innerHTML = `${value}`;
      if (icon) {
        let btnIcon = document.createElement('i');
        btnIcon.classList.add(`ri-${icon}-line`, 'align-bottom', 'mr-2');
        btn.prepend(btnIcon);
      }
      return btn;
    }

    function getKeyByValue(object, value) {
      return Object.keys(object).find(key => object[key] === value);
    }


    function createTableToolbar(obj) {

      const type = Object.keys(savedTables).find(key => savedTables[key].includes(obj));

      let toolbar = document.createElement('div');
      toolbar.classList.add(theme.accentBackgroundColor, 'py-2', 'px-3', 'flex', 'items-center', 'space-x-4');
      let saveAsViewBtn = createButton('Save as View', 'save');
      let addRecordBtn = createButton('Add', 'add');
      let LinkRecordsBtn = createButton('Link to Multiple');
      let tableTitle = document.createElement('h2');
      tableTitle.classList.add(theme.textColor, 'text-lg');
      tableTitle.innerHTML = obj.name;
      toolbar.appendChild(tableTitle);

      let createSection = function (name, content) {
        let section = document.createElement('div');
        let sectionHeader = document.createElement('h4');
        sectionHeader.classList.add(theme.mutedTextColor, 'text-sm')
        sectionHeader.innerText = name;
        let sectionContent = document.createElement('div');
        sectionContent.classList.add('space-x-2');
        content.forEach(c => sectionContent.appendChild(c));
        section.appendChild(sectionHeader);
        section.appendChild(sectionContent);
        return section;
      }

      let recordsContent = [addRecordBtn, LinkRecordsBtn];
      let viewsContent = [saveAsViewBtn];

      if (type == 'tables') {
        toolbar.appendChild(createSection('Records', recordsContent));

        LinkRecordsBtn.addEventListener('click', function () {
          linkToMultiple(obj);
        });
        toolbar.appendChild(createSection('Views', viewsContent));
      }
      // EVENTS
      saveAsViewBtn.addEventListener('click', saveAsView);
      saveAsViewBtn.table = obj;
      return toolbar;
    }


    function saveAsView(e) {
      let selTable = e.target.table;
      let table = { ...selTable };
      let tableId = Object.values(savedTables).flat().map(table => table.id);
      let maxId = Math.max(...tableId);
      table.id = maxId + 1;
      table.columns.forEach(col => col.referencedTable = table.name);
      table.name = `View of ${table.name}`

      savedTables.views.push(table);
      localStorage.setItem('tables', JSON.stringify(savedTables));
      location.reload();
      //document.querySelector('.table-wrapper').appendChild(createTable(table));
    }

    //console.log(savedTables.tables);

    // SET ICONS
    function typeIcon(type) {
      if (type == 'text') {
        return 'text';
      } else if (type == 'number') {
        return 'hashtag';
      } else if (type == 'duration') {
        return 'time-line';
      } else if (type == 'fk') {
        return 'key-fill';
      } else if (type == 'lookup') {
        return 'search-line';
      } else {
        return 'question-mark';
      }
    }

    function createModal(content) {
      let overlay = document.createElement('div');
      let modal = document.createElement('div');
      modal.style.maxWidth = '600px';
      let modalClasses = [theme.backgroundColor, 'p-2', theme.textColor, 'border', 'mx-auto', theme.darkBorderColor];
      modal.classList.add(...modalClasses);
      overlay.classList.add(theme.backgroundColor, 'w-full', 'h-full', 'flex', 'items-center', 'bg-opacity-70');
      overlay.style.position = 'absolute';
      overlay.style.top = '0';
      overlay.style.left = '0';
      let modalContent = document.createElement('div');
      modalContent.appendChild(content);
      modal.appendChild(modalContent);
      overlay.appendChild(modal);
      return overlay;
    }

    //CREATE TABLE
    function createTable(obj) {

      let recordType = obj.columns.reduce(function (a, b) {
        a.push(b.type)
        return a;
      }, []);

      let recordTable = obj.columns.reduce(function (a, b) {
        a.push(b.referencedTable)
        return a;
      }, []);

      let summaryOf = obj.columns.reduce(function (a, b) {
        a.push(b.summaryOf)
        return a;
      }, []);

      let lookupField = obj.columns.reduce(function (a, b) {
        a.push(b.lookupField)
        return a;
      }, []);

      let lookupTable = obj.columns.reduce(function (a, b) {
        a.push(b.lookupTable)
        return a;
      }, []);

      const type = Object.keys(savedTables).find(key => savedTables[key].includes(obj));

      let rowClasses = ['t-row', 'border-b', theme.tableBorderColor];
      let rowHeaderClasses = ['t-row-header', 'p-3', theme.mutedTextColor, 'border-r', theme.tableBorderColor, 'text-xs']
      let cellClasses = ['t-cell', 'border-r', theme.tableBorderColor, theme.mediumBackgroundColor, 'editable-cell'];

      let createHeader = function (col) {
        let header = document.createElement('div');
        header.style.position = 'relative';
        header.classList.add('t-cell', 'p-2', theme.textColor, 'border-r', theme.tableBorderColor, 'flex', 'items-center');
        let headerLabel = document.createElement('div');
        let headerIcon = document.createElement('i');
        headerIcon.classList.add('ri-' + typeIcon(col.type), 'align-bottom', 'border', 'border-gray-500', 'rounded', 'mr-2');
        headerLabel.innerHTML = col.name;
        header.appendChild(headerLabel);
        headerLabel.prepend(headerIcon);

        let headerMenuToggle = document.createElement('button');
        headerMenuToggle.innerHTML = `<i class="ri-arrow-down-s-line align-bottom"></i>`;
        headerMenuToggle.classList.add('ml-auto')
        header.appendChild(headerMenuToggle);
        headerMenuToggle.addEventListener('click', openColumnMenu);

        // CREATE MENU

        let menuWrapper = function () {
          let menuWrapper = document.createElement('div');
          menuWrapper.classList.add(theme.backgroundColor, theme.mediumBorderColor, 'border', 'w-full', 'shadow-md', 'text-sm', 'column-menu');
          menuWrapper.style.top = '40px';
          menuWrapper.style.left = '0';
          menuWrapper.style.position = 'absolute';
          return menuWrapper;
        }

        let createMenuItem = function (label, callback) {
          let menuItem = document.createElement('a');
          menuItem.classList.add('block', 'p-2')
          menuItem.setAttribute('href', 'javascript:void(0)');
          menuItem.innerText = label;
          menuItem.addEventListener('click', function () {
            callback(col);
          }, false);
          return menuItem;
        }

        let createMenuTextInput = function (label) {
          let menuInput = document.createElement('div');
          let input = document.createElement('input');
          let inputLabel = document.createElement('label');
          inputLabel.innerText = label;
          input.setAttribute('type', 'text');
          menuInput.appendChild(inputLabel);
          menuInput.appendChild(input);
          return menuInput;
        }

        let createHeaderMenu = function (col) {

          let menu = menuWrapper();

          // CREATE MENU ITEMS
          let dataTypeOption = document.createElement('a');
          dataTypeOption.setAttribute('href', 'javascript:void(0)');
          dataTypeOption.classList.add('p-2', 'border-b', theme.mediumBorderColor, 'flex', 'items-center', 'block');
          let dataTypeLabel = document.createElement('div');
          dataTypeLabel.classList.add('text-base');
          dataTypeOption.appendChild(dataTypeLabel);
          let dataTypeIcon = document.createElement('i');
          dataTypeIcon.classList.add('ri-' + typeIcon(col.type), 'border', 'align-bottom', 'border-gray-500', 'rounded', 'mr-2');
          dataTypeLabel.innerHTML = col.type;
          dataTypeLabel.prepend(dataTypeIcon);
          dataTypeOption.addEventListener('click', openDataTypeMenu);

          //ADD MENU ITEMS
          let menuItems = [
            dataTypeOption,
            createMenuItem('Link to Another Table', linkToTable),
            createMenuItem('Insert New Column'),
            createMenuItem('Rename Column'),
            createMenuItem('Duplicate Column'),
            createMenuItem('Filter Column'),
            createMenuItem('Sort Column'),
            createMenuItem('Group Column'),
            createMenuItem('Delete Column')
          ];

          menuItems.forEach(item => menu.appendChild(item));
          return menu;
        }

        let createTypeMenu = function (col) {
          let menu = menuWrapper();
          menu.innerText = 'TEST';
          let menuItems = [
            createMenuTextInput('Field Size Limit')
          ];
          menuItems.forEach(item => menu.appendChild(item));

          return menu;
        }

        function menuAction(menu) {
          return function () {
            console.log("Clicked on createHeaderMenu -> menuAction item");
            menu.parentElement.removeChild(menu);
            removeDropdownOutsideClickHandler(menu);
          }
        }

        function openColumnMenu(e) {
          let menu = createHeaderMenu(col);
          header.appendChild(menu);
          addDropdownOutsideClickHandler(menu, () => console.log("Clicked outside when openColumnMenu was open"));
        }

        function openDataTypeMenu(e) {
          console.log('datatypesshow');
        }

        return header;
      };

      let getColumnByPosition = function (int) {
        return obj.columns[int];
      }

      let createCell = function (cell, i) {
        let cellElement = document.createElement('div');
        cellElement.classList.add(...cellClasses);
        let cellType = getColumnByPosition(i).type;
        let renderedCell = document.createElement('div');
        renderedCell.classList.add(theme.textColor, 'p-2', 'rendered-cell', 'h-full', 'space-y-1');
        renderedCell.style.cursor = 'pointer';

        let createRecordLink = function (cell) {
          let link = document.createElement('div');
          link.classList.add(theme.primaryColor, 'rounded', 'px-1', 'inline-block', 'bg-opacity-50', 'mr-1');
          link.innerHTML = cell;
          return link;
        }

        if (cellType == 'fk') {
          renderedCell.appendChild(createRecordLink(cell));
        } else if (cellType == 'summary') {
          cell.split(',').forEach(c => renderedCell.appendChild(createRecordLink(c)))
        }
        else {
          renderedCell.innerHTML = cell;
        }

        let cellInput = document.createElement('input');
        cellInput.setAttribute('type', 'text');
        cellInput.setAttribute('value', cell);
        cellInput.classList.add(theme.inputBackgroundColor, theme.textColor, 'p-2', 'w-full', 'hidden');


        if (summaryOf[i] && recordTable[i]) {
          renderedCell.addEventListener('dblclick', function () {
            cellInput.classList.remove('hidden');
            cellInput.focus();
            renderedCell.classList.add('hidden');
            cellElement.appendChild(createRecordListMenu(cellInput, recordTable[i], summaryOf[i], cell));
          });
        } else if (recordTable[i]) {
          renderedCell.addEventListener('dblclick', function () {
            cellInput.classList.remove('hidden');
            cellInput.focus();
            renderedCell.classList.add('hidden');
            cellElement.appendChild(createEditRecordMenu(cellInput, recordTable[i], cell));
          });
        } else if (lookupTable[i]) {
          renderedCell.addEventListener('dblclick', function () {
            cellInput.classList.remove('hidden');
            cellInput.focus();
            renderedCell.classList.add('hidden');
            cellElement.appendChild(createLookupMenu(cellInput, lookupTable[i], lookupField[i], cell));
          });
        } else {
          renderedCell.addEventListener('dblclick', function () {
            cellInput.classList.remove('hidden');
            cellInput.focus();
            renderedCell.classList.add('hidden');
            cellInput.addEventListener('blur', function () {
              renderedCell.innerHTML = cellInput.value;
              cellInput.classList.add('hidden');
              renderedCell.classList.remove('hidden');
              let editedRecord = obj.records.find(record => record.includes(cell));
              let recordIndex = editedRecord.indexOf(cell);
              editedRecord[recordIndex] = cellInput.value;
              document.querySelector('.table-wrapper').innerHTML = '';
              document.querySelector('.table-wrapper').appendChild(createTable(obj));
            })
          });
        }

        cellElement.appendChild(cellInput);
        cellElement.appendChild(renderedCell);

        return cellElement;
      }

      let createRow = function (record, i) {
        let rowCount = i + 1;
        let row = document.createElement('div');
        row.classList.add(...rowClasses);
        let rowNumber = document.createElement('div');
        rowNumber.classList.add(...rowHeaderClasses);
        rowNumber.innerHTML = `${rowCount}`;
        record.forEach((cell, i) => row.appendChild(rowNumber));
        record.forEach((cell, i) => row.appendChild(createCell(cell, i)));
        return row;
      }


      let createNewRow = function (columns) {

        let row = document.createElement('div');
        row.classList.add(...rowClasses);

        let rowNumber = document.createElement('div');
        rowNumber.classList.add(...rowHeaderClasses);
        rowNumber.innerHTML = `*`;
        row.appendChild(rowNumber);

        let placeholderValue = function (col) {
          if (col.referencedTable) {
            return `Add Record to '${col.referencedTable}'`
          } else if (col.type == 'fk') {
            return `Search from '${col.lookupField}'`
          } else {
            return `Add Record`
          }
        }

        columns.forEach(function (col, i) {

          let cell = document.createElement('div');
          cell.classList.add(...cellClasses)
          let cellInput = document.createElement('input');
          cellInput.setAttribute('type', 'text');
          cellInput.setAttribute('placeholder', placeholderValue(col));
          cellInput.classList.add(theme.inputBackgroundColor, theme.textColor, 'p-2', 'w-full');
          cell.appendChild(cellInput);
          row.appendChild(cell);
          cellInput.addEventListener('keydown', function () {
            if (!row.newRowCreated) {
              row.newRowCreated = true;
              newRowWrapper.prepend(repositionWarning);
              newRowWrapper.appendChild(createNewRow(obj.columns));
              if (recordTable[i]) {
                console.log('table', recordTable[i])
                cellInput.parentNode.appendChild(createEditRecordMenu(cellInput, recordTable[i], ''))
              }
              resizeColumns(table);
            }
          });
        });



        return row;
      }

      let table = document.createElement('div');
      let tableClasses = ['t-table', theme.backgroundColor];
      table.classList.add(...tableClasses);
      let rowWrapper = document.createElement('div');
      rowWrapper.classList.add('t-body', 'row-wrapper');
      let headerWrapper = document.createElement('div');
      let headerRow = document.createElement('div');
      let headerRowSelect = document.createElement('div');
      headerRowSelect.classList.add('t-row-header', 'p-2');
      headerRow.classList.add('t-row', 'border-b', theme.tableBorderColor);
      headerRow.appendChild(headerRowSelect);
      headerWrapper.appendChild(headerRow);
      headerWrapper.classList.add('t-head', 'row-wrapper');

      obj.columns.forEach(col => headerRow.appendChild(createHeader(col)));
      obj.records.forEach((record, index) => rowWrapper.appendChild(createRow(record, index)));
      table.appendChild(headerWrapper);
      table.appendChild(rowWrapper);

      let newRowWrapper = document.createElement('div');
      newRowWrapper.classList.add('t-body', 'row-wrapper');
      table.appendChild(newRowWrapper);
      newRowWrapper.appendChild(createNewRow(obj.columns));

      let repositionWarning = document.createElement('div');
      repositionWarning.classList.add('p-1', theme.textColor, 'bg-green-700', 'text-sm');
      repositionWarning.innerHTML = `New records will be repositioned on refresh`;

      resizeColumns(table);
      return table;
    }

    //linkToMultiple({ name: 'trackId', type: 'text' });



    function linkToTable(col) {
      let linkTableForm = document.createElement('div');
      linkTableForm.innerHTML = '<h4>Select Table</h4>';
      document.querySelector('body').appendChild(createModal(linkTableForm));

      let tableSelector = document.createElement('div');
      linkTableForm.appendChild(tableSelector);
      savedTables.tables.filter(table => table.id != activeTable).forEach(function (table) {
        let item = document.createElement('a');
        item.setAttribute('href', 'javascript:void(0)')
        item.classList.add('border', theme.lightBorderColor, 'p-1', 'block');
        item.innerHTML = `${table.name} <span class="${theme.mutedTextColor}">${table.columns[1].name}</span>`;
        item.addEventListener('click', function () {
          col.type = 'fk';
          col.lookupField = 'trackName';
          col.lookupTable = 'track';
          col.referencedTable = '';
          document.querySelector('.table-wrapper').innerHTML = '';
          document.querySelector('.table-wrapper').appendChild(createTable(selectTableById(activeTable)));
          linkTableForm.parentNode.parentNode.parentNode.remove();
        });
        tableSelector.appendChild(item);
      });


    }

    //linkToMultiple(savedTables.tables[0]);


    function linkToMultiple(table) {
      let form = document.createElement('div');
      form.innerHTML = `
      <h4 class="text-lg mb-2">Link Multiple Records to '${table.name}'</h4>
      <p class="mb-2">You need to create a view to link this table records to multiple records from another table.</p>
      <p>Select the table from which you want to link the records from:</p>
      `;
      document.querySelector('body').appendChild(createModal(form));

      let tableSelector = document.createElement('div');
      form.appendChild(tableSelector);
      savedTables.tables.filter(table => table.id != activeTable).forEach(function (table) {
        let item = document.createElement('a');
        item.setAttribute('href', 'javascript:void(0)')
        item.classList.add('border', theme.lightBorderColor, 'p-1', 'block');
        item.innerHTML = `${table.name} <span class="${theme.mutedTextColor}">${table.columns[1].name}</span>`;
        item.addEventListener('click', function () {
          selectedTable.push(table);
          item.classList.add(theme.mediumBackgroundColor);
        });
        tableSelector.appendChild(item);
      });

      selectedTable = [];

      let formActions = document.createElement('div');
      formActions.classList.add('mt-2');
      let createViewBtn = createButton('Create View');

      formActions.appendChild(createButton('Cancel'));
      formActions.appendChild(createViewBtn);
      createViewBtn.addEventListener('click', function () {

        let tableId = Object.values(savedTables).flat().map(table => table.id);
        let maxId = Math.max(...tableId);
        let sourceTable = JSON.parse(JSON.stringify(table));
        let newView = {
          name: `${selectedTable[0].name} by ${sourceTable.name}`,
          id: maxId + 1,
          columns: sourceTable.columns,
          records: sourceTable.records,
          color: 'purple'
        };

        newView.columns.push({
          name: 'trackSummary', type: 'fk', lookupField: 'trackName', lookupTable: 'track'
        });

        newView.records.forEach(record => record.push(''));

        console.log(newView);

        savedTables.views.push(newView);
        localStorage.setItem('tables', JSON.stringify(savedTables));

        form.parentNode.parentNode.parentNode.remove();
        location.reload();
      });



      let warning = document.createElement('div');
      warning.innerHTML = `<div class="mt-2 text-sm ${theme.mutedTextColor}">A junction table will be created in order to establish a many-to-many relationship between the current and the selected table.</div>`;

      form.appendChild(warning);
      form.appendChild(formActions);

    }

    function createIcon(type) {
      let icon = document.createElement('i');
      icon.classList.add('ri-' + typeIcon(type), 'align-bottom', 'border', theme.lightBorderColor, 'rounded', 'mr-1');
      return icon;
    }

    function createEditRecordMenu(input, table, value) {
      console.log(value);
      let menu = document.createElement('div');
      menu.classList.add('edit-dropdown', 'shadow-md', theme.backgroundColor, 'p-2', 'space-y-2');
      menu.style.position = 'absolute';
      menu.style.minWidth = '280px';
      let menuHeader = document.createElement('h4');
      menuHeader.classList.add(theme.textColor);
      menuHeader.innerHTML = `Edit record in '${table}'`;
      menu.appendChild(menuHeader);



      let records = selectTableByName(table).records.find(record => record.includes(value));



      let createFormGroup = function (field, i) {
        console.log(field.name, i)
        let formGroup = document.createElement('div');
        let control = document.createElement('input');
        control.classList.add(theme.inputBackgroundColor, theme.textColor, 'p-2', 'w-full');
        let label = document.createElement('label');
        label.classList.add(theme.textColor, 'block');
        label.innerHTML = `${field.name}`;
        label.prepend(createIcon(field.type));
        if (records) { control.setAttribute('value', records[i]); }
        formGroup.appendChild(label);
        formGroup.appendChild(control);

        if (i == 1) {
          label.classList.add('font-semibold');
          label.prepend(createIcon('lookup'));
          control.addEventListener('keyup', function () {
            let newValue = control.value;
            input.setAttribute('value', newValue);
          });
        }

        return formGroup;
      }

      selectTableByName(table).columns.forEach((field, i) => menu.appendChild(createFormGroup(field, i)));

      addDropdownOutsideClickHandler(menu, function () {
        let selectedTable = selectTableById(activeTable);
        let editedRecord = selectedTable.records.find(record => record.includes(value));
        let recordIndex = editedRecord.indexOf(value);
        editedRecord[recordIndex] = input.value;
        document.querySelector('.table-wrapper').innerHTML = '';
        document.querySelector('.table-wrapper').appendChild(createTable(selectedTable));
      });

      let deleteRecordBtn = createButton('Delete Record', 'delete-bin');
      let goToTableBtn = createButton('Go to Table', 'table');

      menu.appendChild(deleteRecordBtn);
      //menu.appendChild(goToTableBtn);


      return menu;
    }

    function createRecordListMenu(input, table, field, cell) {

      

      let summary = field;
      let menu = document.createElement('div');
      menu.classList.add('edit-dropdown', 'shadow-md', theme.backgroundColor, 'p-2', 'space-y-2');
      menu.style.position = 'absolute';
      menu.style.minWidth = '280px';
      let menuHeader = document.createElement('h4');
      menuHeader.classList.add(theme.textColor);
      menuHeader.innerHTML = `Edit records in '${table}'`;
      menu.appendChild(menuHeader);

      let columnPosition = selectTableByName(table).columns.map((col, i) => col.name == field ? i : '').join('');
      let summaryRecords = selectTableByName(table).records.map(record => record[columnPosition]);
      let activeRecords = input.value.split(',');

      let createRecordsList = function (record, i) {
        let recordsList = document.createElement('a');
        recordsList.setAttribute('href', 'javascript:void(0)');
        recordsList.innerHTML = record.map(item => `<div class="mr-2">${item}</div>`).join('');
        let removeRecord = document.createElement('button');
        removeRecord.classList.add('border', theme.lightBorderColor, 'rounded', 'px-1', 'ml-auto')
        removeRecord.innerHTML = `<i class="ri-delete-bin-line align-bottom"></i>`;
        
        if (activeRecords.includes(record[columnPosition])) {
          recordsList.classList.add(theme.primaryColor, 'bg-opacity-70', theme.textColor, 'flex', 'p-1', 'rounded', 'items-center');
          recordsList.addEventListener('click',function(){
            input.setAttribute('value',input.value.split(',').map(v => v !== record[columnPosition]?v:'').filter(v => v.length > 0).join(','));           
            menu.remove();
            input.parentNode.append(createRecordListMenu(input, table, field, input.value));
          });
        } else {
          recordsList.classList.add(theme.primaryColor, 'bg-opacity-20', theme.textColor, 'flex', 'p-1', 'rounded', 'items-center');
          recordsList.addEventListener('click',function(){
            console.log(input.value);
            if (input.value.length > 0) {
              input.setAttribute('value',input.value+','+record[columnPosition]);
            } else {
              input.setAttribute('value',record[columnPosition]);
            }
            menu.remove();
            input.parentNode.append(createRecordListMenu(input, table, field, input.value));
          });
        }

        //recordsList.appendChild(removeRecord);
        return recordsList;
      }

      let searchRecords = document.createElement('input');
      searchRecords.classList.add(theme.inputBackgroundColor, 'p-2', 'w-full')
      menu.appendChild(searchRecords);
      let listWrapper = document.createElement('div');
      listWrapper.classList.add('border', 'space-y-2', 'p-1', theme.mediumBorderColor);
      menu.appendChild(listWrapper);

      let newRecordButton = createButton('New Record', 'add');
      menu.appendChild(newRecordButton);
      
      let createList = function(records){
        records.forEach(function (summaryValue) {
          selectTableByName(table).records.filter(record => record.includes(summaryValue)).forEach((record, i) => listWrapper.appendChild(createRecordsList(record, i)));;
        });
        
      }

      createList(summaryRecords);
      
      

      addDropdownOutsideClickHandler(menu, function () {
        //console.log(menu);
        let selectedTable = selectTableById(activeTable);
        let editedRecord = selectedTable.records.find(record => record.includes(cell));
        let recordIndex = editedRecord.indexOf(cell);
        editedRecord[recordIndex] = input.value;
        document.querySelector('.table-wrapper').innerHTML = '';
        document.querySelector('.table-wrapper').appendChild(createTable(selectedTable));
      });

      

      return menu;
    }

    function createLookupMenu(input, table, field, value) {
      let menu = document.createElement('div');
      menu.classList.add('edit-dropdown', 'shadow-md', theme.backgroundColor, 'p-2', 'space-y-2');
      menu.style.position = 'absolute';
      menu.style.minWidth = '280px';
      let menuHeader = document.createElement('h4');
      menuHeader.classList.add(theme.textColor);
      menuHeader.innerHTML = `Lookup records in '${table}'`;
      menuLookupField = document.createElement('div');
      menuLookupField.classList.add(theme.mutedTextColor, 'text-sm')
      menuLookupField.innerHTML = `Lookup field: ${field}`;
      menu.appendChild(menuHeader);
      menu.appendChild(menuLookupField);

      let columnPosition = selectTableByName(table).columns.map((col, i) => col.name == field ? i : '').join('');
      let summaryRecords = selectTableByName(table).records.map(record => record[columnPosition]);

      summaryRecords.forEach(function (record) {
        let item = document.createElement('a');
        item.setAttribute('href', 'javascript:void(0)');
        item.classList.add(theme.textColor, 'p-1', theme.primaryColor, 'bg-opacity-50', 'block')
        item.innerHTML = `${record}`
        item.addEventListener('click', function () {
          linkRecord(record);
        });
        menu.appendChild(item);
      });

      let allowMultiple = createButton('Add Multiple', 'add');
      //menu.appendChild(allowMultiple);

      allowMultiple.addEventListener('click', function () {
        let warning = document.createElement('div');
        warning.innerHTML = `<div class="mb-2">A junction table will be created in order to establish a many-to-many relationship between the current and the selected table.</div>`;
        let warningActions = document.createElement('div');
        warning.appendChild(warningActions);
        warningActions.classList.add('space-x-2');
        warningActions.appendChild(createButton('Cancel'));
        warningActions.appendChild(createButton('Create Table'));

        document.querySelector('body').appendChild(createModal(warning));
      });

      function linkRecord(record) {
        input.setAttribute('value', record);
      }

      addDropdownOutsideClickHandler(menu, function () {
        let selectedTable = selectTableById(activeTable);
        let editedRecord = selectedTable.records.find(record => record.includes(value));
        let recordIndex = editedRecord.indexOf(value);
        console.log(recordIndex);
        editedRecord[recordIndex] = input.value;
        document.querySelector('.table-wrapper').innerHTML = '';
        document.querySelector('.table-wrapper').appendChild(createTable(selectedTable));
      });

      return menu;
    }

    function isNodeChildOf(obj, parentObj) {
      while (obj != undefined && obj != null && obj.tagName.toLowerCase() != 'body') {
        if (obj == parentObj) {
          return true;
        }
        obj = obj.parentNode;
      }
      return false;
    }

    function removeDropdownOutsideClickHandler(menu) {
      if (menu.outsideClickHandler) {
        document.removeEventListener('click', menu.outsideClickHandler);
      }
    }

    function addDropdownOutsideClickHandler(menu, callback) {
      function handler(event) {
        var isClickInsideElement = isNodeChildOf(event.target, menu);
        if (!isClickInsideElement) {
          console.log('outside')
          callback(menu);
          menu.remove();
          document.removeEventListener('click', handler);
          menu.outsideClickHandler = null;
        }
      }

      removeDropdownOutsideClickHandler(menu);

      setTimeout(function () {
        document.addEventListener('click', handler);
        menu.outsideClickHandler = handler;
      }, 0);
    }

    function resizeColumns(table) {
      cells = table.querySelectorAll('.t-cell');
      cells.forEach(cell => cell.style.width = '260px');
      rowHeaders = table.querySelectorAll('.t-row-header');
      rowHeaders.forEach(rowHeader => rowHeader.style.width = '48px')
      return table;
    }

    function renderCell(input) {
      //console.log(input.parentNode);


      //input.classList.add('hidden');
      //input.parentNode.childNodes[1].innerHTML = input.getAttribute('value');
      //input.parentNode.childNodes[1].classList.remove('hidden');
      return input;
    }

    var doubleClickEvent = document.createEvent('MouseEvents');
    doubleClickEvent.initEvent('dblclick', true, true);

    //document.querySelectorAll('.rendered-cell')[3].dispatchEvent(doubleClickEvent);

    function enableInput(el) {
      let cellInput = el.parentNode.querySelector('input');
      let renderedCell = el.parentNode.querySelector('.rendered-cell');
      cellInput.classList.remove('hidden');
      renderedCell.classList.add('hidden');
      cellInput.focus();
    }


    function editField(evt) {
      enableInput(this);
    }

    function selectCell(e) {
      let row = this.parentNode.parentNode;
      let cell = this;
      let selectedRowClasses = [];
      let selectedCellClasses = [theme.primaryColor, 'bg-opacity-20'];
      let selectedRowNumberClasses = ['font-bold', theme.primaryColor, 'bg-opacity-50'];
      document.querySelectorAll('.selected-cell').forEach(cell => cell.classList.remove('selected-cell', ...selectedCellClasses));
      document.querySelectorAll('.selected-row').forEach(row => row.childNodes[0].classList.remove(...selectedRowNumberClasses));
      document.querySelectorAll('.selected-row').forEach(row => row.classList.remove('selected-row', ...selectedRowClasses));
      cell.classList.add('selected-cell');
      row.classList.add('selected-row');
      document.querySelectorAll('.selected-cell').forEach(cell => cell.classList.add(...selectedCellClasses));
      document.querySelectorAll('.selected-row').forEach(row => row.classList.add(...selectedRowClasses));
      document.querySelectorAll('.selected-row').forEach(row => row.childNodes[0].classList.add(...selectedRowNumberClasses));
      return false;
    }

    //initNewRecord();
    function initNewRecord() {
      let newRecord = document.querySelector('.add-new-record');
      newRecord.querySelectorAll('input').forEach(function (element) {
        element.addEventListener('keydown', addRow);
      });
    }

    function addRow(e) {

      let row = this.parentNode.parentNode
      let newRow = row.cloneNode(true);
      row.classList.remove('add-new-record');
      let newRowClasses = ['border-t', 'border-b', 'border-green-400'];
      row.classList.add(...newRowClasses);

      row.querySelectorAll('input').forEach(function (element) {
        element.removeEventListener('keydown', addRow);
      });

      let idMax = selectTableById(activeTable).records.map(record => record[0]).reduce((a, b) => (a.id > b.id) ? a : b);
      selectTableById(activeTable).records.push([idMax + 1, '']);
      row.querySelectorAll('input')[0].setAttribute('value', idMax + 1);
      let rowNumber = document.querySelectorAll('.t-body .t-row').length;
      let rowNumberCell = row.querySelector('.t-row-header');
      rowNumberCell.innerHTML = `${rowNumber}*`;
      rowNumberCell.classList.add('text-green-400', 'font-bold')

      let newRowCount = document.querySelector('.row-wrapper--add').querySelectorAll('.t-row').length;

      if (newRowCount == 1) {
        let repositionWarning = document.createElement('div');
        repositionWarning.innerHTML = `<div class="text-white text-xs bg-green-600 p-1">New records will be repositioned on refresh</div>`
        document.querySelector('.row-wrapper--add').prepend(repositionWarning);
      }
      document.querySelector('.row-wrapper--add').append(newRow);
    }

    let addColumnBtn = document.querySelector('#add-column');

    //addColumnBtn.addEventListener('click', addColumn);

    //addColumn();

    function addColumn() {
      let wrapper = document.querySelector('.table-wrapper');
      wrapper.appendChild(createAddColumnMenu(savedTables))
    }



    function createAddColumnMenu(savedTables) {

      let listColumns = table => table.columns.map(col => `<a href="#" class="block px-2 py-1"><i class="ri-${typeIcon(col)} text-xs text-${table.color}-400 align-text-bottom border border-${table.color}-400 rounded mr-2"></i><span class="${theme.textColor}">${col.name}</span></a>`).join('');
      let tables = savedTables.tables.map(table => `<div class="px-2 py-1 border-b ${theme.mediumBorderColor}"><span class="${theme.mediumTextColor} text-sm"><i class="ri-table-fill align-bottom mr-1"></i>From ${table.name}</span></div><div>${listColumns(table)}</div>`).join('');
      let html =
        `<div class="${theme.backgroundColor} border ${theme.mediumBorderColor}">
        <h4 class="text-xs ${theme.mutedTextColor} py-1 px-2">Add Column</h4>
        <input type="text" class="${theme.inputBackgroundColor} w-full p-2 text-sm ${theme.textColor} border-b ${theme.mediumBorderColor}" placeholder="Type to search">
        <div>${tables}</div>
      </div>`;
      let menuHtml = document.createElement('div');
      menuHtml.innerHTML = html;
      return menuHtml;
    }

  </script>

  <script src="js/vendor/modernizr-3.11.2.min.js"></script>
  <script src="js/plugins.js"></script>
  <script src="js/main.js"></script>
</body>

</html>